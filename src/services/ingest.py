import jsonfrom datetime import datetime, timezonefrom src.db.session import session_scopefrom src.db.models import RawApiResponse, Product, PriceHistoryfrom src.services.dummyjson_client import fetch_productdef _now_iso() -> str:    return datetime.now(timezone.utc).isoformat()def ingest_product(product_id: int) -> dict:    data = fetch_product(product_id)    fetched_at = _now_iso()    title = data.get("title") or f"product_{product_id}"    brand = data.get("brand")    category = data.get("category")    price = float(data.get("price"))    with session_scope() as s:        s.add(            RawApiResponse(                fetched_at=fetched_at,                source="dummyjson",                endpoint=f"/products/{product_id}",                payload_json=json.dumps(data, ensure_ascii=False),            )        )        prod = s.get(Product, product_id)        if prod is None:            prod = Product(                product_id=product_id,                title=title,                brand=brand,                category=category,                last_seen_at=fetched_at,            )            s.add(prod)        else:            prod.title = title            prod.brand = brand            prod.category = category            prod.last_seen_at = fetched_at        s.add(            PriceHistory(                product_id=product_id,                fetched_at=fetched_at,                price=price,                currency="USD",            )        )    return {        "product_id": product_id,        "title": title,        "price": price,        "fetched_at": fetched_at,    }def get_last_price_delta(product_id: int) -> dict:    with session_scope() as s:        rows = (            s.query(PriceHistory)            .filter(PriceHistory.product_id == product_id)            .order_by(PriceHistory.fetched_at.desc())            .limit(2)            .all()        )    if not rows:        return {"current_price": None, "prev_price": None, "diff": None, "percent": None}    current_price = float(rows[0].price)    if len(rows) == 1:        return {"current_price": current_price, "prev_price": None, "diff": None, "percent": None}    prev_price = float(rows[1].price)    diff = current_price - prev_price    percent = (diff / prev_price) * 100 if prev_price != 0 else 0.0    return {"current_price": current_price, "prev_price": prev_price, "diff": diff, "percent": percent}