import jsonfrom datetime import datetime, timezonefrom src.db.sqlite import get_connfrom src.services.dummyjson_client import fetch_productdef _now_iso() -> str:    return datetime.now(timezone.utc).isoformat()def ingest_product(product_id: int) -> dict:    data = fetch_product(product_id)    fetched_at = _now_iso()    title = data.get("title") or f"product_{product_id}"    brand = data.get("brand")    category = data.get("category")    price = float(data.get("price"))    conn = get_conn()    try:        conn.execute(            "INSERT INTO raw_api_responses(fetched_at, source, endpoint, payload_json) VALUES(?,?,?,?)",            (fetched_at, "dummyjson", f"/products/{product_id}", json.dumps(data, ensure_ascii=False)),        )        conn.execute(            """            INSERT INTO products(product_id, title, brand, category, last_seen_at)            VALUES(?,?,?,?,?)            ON CONFLICT(product_id) DO UPDATE SET              title=excluded.title,              brand=excluded.brand,              category=excluded.category,              last_seen_at=excluded.last_seen_at            """,            (product_id, title, brand, category, fetched_at),        )        conn.execute(            "INSERT INTO prices_history(product_id, fetched_at, price, currency) VALUES(?,?,?,?)",            (product_id, fetched_at, price, "USD"),        )        conn.commit()    finally:        conn.close()    return {        "product_id": product_id,        "title": title,        "price": price,        "fetched_at": fetched_at,    }def get_last_price_delta(product_id: int) -> dict:    conn = get_conn()    try:        rows = conn.execute(            """            SELECT price, fetched_at            FROM prices_history            WHERE product_id=?            ORDER BY fetched_at DESC            LIMIT 2            """,            (product_id,),        ).fetchall()    finally:        conn.close()    if not rows:        return {            "current_price": None,            "prev_price": None,            "diff": None,            "percent": None,        }    current_price = float(rows[0]["price"])    if len(rows) == 1:        return {            "current_price": current_price,            "prev_price": None,            "diff": None,            "percent": None,        }    prev_price = float(rows[1]["price"])    diff = current_price - prev_price    percent = (diff / prev_price) * 100 if prev_price != 0 else 0.0    return {        "current_price": current_price,        "prev_price": prev_price,        "diff": diff,        "percent": percent,    }